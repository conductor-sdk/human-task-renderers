name: Continuous Delivery

on:
  release:
    types: [published]

jobs:
  build-and-publish-packages:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"

      - name: Set Release Version
        run: echo "RELEASE_VERSION=${GITHUB_REF_NAME}" >> $GITHUB_ENV

      - name: Find package directories
        id: find-packages
        run: |
          echo "PACKAGE_DIRS=$(find . -name package.json -exec dirname {} \; | grep -v 'node_modules')" >> $GITHUB_ENV

      - name: Install, Build and Publish Packages
        run: |
          for dir in $PACKAGE_DIRS; do
            cd $dir

            # Bump version to release
            sed -i "s/v0.0.0/$RELEASE_VERSION/" ./package.json

            # Install dependencies
            yarn install

            # Build package
            yarn build

            # Publish package
            npm publish --access public

            cd -
          done
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
